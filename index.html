<!DOCTYPE html>
<html>
<head>
<title>Loading...</title>
</head>

<body>
  <h1>Open a website hosted on the BitTorrent network</h1>
  <p id="status"></p>
  <p id="substatus"></p>
  <div id="form">
    <p>Download from hash or magnet link.</p>
    <input onkeydown="submit(event)" type="text" id="textbox" placeholder="magnet:">
    <button onclick="submit(event)" type="button">Download</button>
  </div>
  <div id="log">
    <br>
    <p id="numpeers">Peers: 0</p>
    <p id="progress">Progress: 0%</p>
    <p id="length">Size: loading...</p>
    <p id="timeremaining">âˆž remaining</p>
    <p><b><u>Magnet Parameters</u></b></p>
  </div>
    
<script>
function run(){
  if (window.location.hash){
    if (window.location.hash.substr(1,8) == "magnet:?"){
      var hash = (window.location.hash.substr((window.location.hash.indexOf("xt=urn:btih:") + 12), 40))
      var parameters = window.location.hash.substr(9).split("&")
      parameters.forEach(function(parameter){
        var node = document.createElement("li");
        node.appendChild(document.createTextNode(parameter));
        document.getElementById("log").appendChild(node);
      })
      console.log(parameters)
      download(hash);
      if (window.location.hash.indexOf("xt=urn:btmh:") != -1){
        console.log("Multihash not supported.");
      }
    } else if (window.location.hash.length == 41){
      var hash = window.location.hash.substr(1);
      download(hash);
    } else if (window.location.hash.length == 33){
      console.log("Base32 not supported")
    } else {
      document.getElementById("status").innerHTML = "Invalid.";
    }
  } else {
    
  }
}
run();

function submit(event){
  if ((event.key==='Enter') || (event.buttons===0)){
  window.location.hash = document.getElementById("textbox").value.trim();
  run();
  }
}

function progress(torrent){
  document.getElementById("progress").innerHTML = "Progress: "+Math.round(torrent.progress*100)+"%";
  document.getElementById("numpeers").innerHTML = "Peers: "+torrent.numPeers;
  document.getElementById("length").innerHTML = "Size: "+torrent.length+"B";
  document.getElementById("timeremaining").innerHTML = Math.round(torrent.timeRemaining/1000)+" s remaining";
}

function download(hash){
  document.getElementById("form").style.display = "none";
  document.getElementById("status").innerHTML = "Loading: " + hash;
  document.getElementById("substatus").innerHTML = "This may take a minute.";
  wait(hash);
}
function wait(hash){
  if (typeof WebTorrent !== 'undefined'){
    downloadtorrent(hash);
  } else {
    setTimeout(function() { wait(hash) }, 50);
  }
}
function downloadtorrent(hash){
  var magnetbase = 'magnet:?dn=index.html&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=wss%3A%2F%2Ftracker.webtorrent.io&xt=urn:btih:';
  var magnet = magnetbase + hash;
  var client = new WebTorrent();
  client.add(magnet, function(torrent){
    var progress = setInterval(function(){
      document.getElementById("progress").innerHTML = "Progress: "+Math.round(torrent.progress*100)+"%";
      document.getElementById("numpeers").innerHTML = "Peers: "+torrent.numPeers;
      document.getElementById("length").innerHTML = "Size: "+torrent.length+"B";
      document.getElementById("timeremaining").innerHTML = Math.round(torrent.timeRemaining/1000)+" s remaining";
    }, 1000);
    var file = torrent.files[0];
    file.getBuffer(function(err, buffer){
      clearInterval(progress);
      document.open();
      document.write(buffer.toString());
      document.close();
      
    })
  })
}
</script>
<script src="https://cdn.jsdelivr.net/npm/webtorrent@0.107.17/webtorrent.min.js"></script>
</body>
</html>
